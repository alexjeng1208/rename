# 更新日誌

## v2.0.0 (最新版本)

### ✨ 新功能

#### 用戶體驗增強
- **鍵盤快捷鍵支援**
  - `Ctrl+O` - 選擇檔案
  - `Ctrl+D` - 選擇資料夾
  - `Delete` - 刪除選中項目
  - `Ctrl+F` - 聚焦到搜尋框
  - `Ctrl+Z` - 撤銷重命名
  - `Ctrl+R` - 預覽重新命名
  - `Ctrl+Enter` - 執行重新命名
  - `Ctrl+T` - 切換深色模式

- **設定檔記憶功能**
  - 自動記住最後使用的命名規則設定
  - 記住角色編號、類型、索引等參數
  - 記住視窗大小和位置
  - 記住最大檔案數限制
  - 記住深色模式偏好

- **撤銷重命名功能**
  - 支援撤銷最後一次重命名操作
  - 記錄重命名歷史（最多1000筆）
  - 支援查看和還原歷史記錄

- **檔案搜尋過濾功能**
  - 實時過濾檔案列表
  - 顯示過濾結果數量
  - 支援快捷鍵聚焦

- **進度條和視覺回饋**
  - 執行重命名時顯示進度條
  - 顯示處理進度
  - 工具提示（Tooltip）功能

- **深色模式支援**
  - 支援淺色/深色主題切換
  - 自動保存偏好設定

#### 功能增強
- **限制選擇數量功能**
  - 可設定最大選擇數量（0=無限制）
  - 超過限制時會顯示警告

- **資料夾路徑導入**
  - 支援直接輸入資料夾路徑並導入
  - 支援拖放資料夾到視窗

- **僅處理選中項功能**
  - 可選擇僅處理選中的檔案
  - 多選時按順序自動排序命名

### 🔒 安全增強

- **路徑驗證**
  - 防止路徑遍歷攻擊
  - 驗證路徑長度和合法性
  - 拒絕UNC路徑和非法字符

- **文件名驗證**
  - Character格式精確驗證
  - 遊戲引擎標準驗證
  - 自動清理非法字符

- **資源管理**
  - 圖片資源自動釋放
  - 防止內存泄漏
  - 優化資源使用

- **輸入驗證**
  - 所有用戶輸入都經過驗證
  - 範圍限制（角色編號1-99，索引1-20，顏色0-6）
  - 異常處理和錯誤恢復

### 🐛 重要Bug修復

- **預覽功能修復**
  - 修復切換參數時預覽消失的問題
  - 修復預覽不實時更新的問題
  - 實現真正的實時預覽更新機制
  
- **技術細節**
  - 實現異步圖片加載（不阻塞UI）
  - 添加唯一加載ID追蹤機制
  - 實現雙重檢查防止過時預覽覆蓋新預覽
  - 在顯示預覽時實時生成文件名（而非使用預先生成的名稱）
  - 添加完整的異常處理和降級顯示

- **UI滾動功能**
  - 添加主窗口滾動條
  - 支持小屏幕顯示所有UI元素
  - 鼠標滾輪支持

### 🔧 改進

- **程式碼重構**
  - 模組化設計（`config.py`, `utils.py`, `ui_theme.py`, `security_utils.py`, `filename_validator.py`）
  - 代碼結構優化
  - 錯誤處理改進
  - 添加 `IN_EXE` 全局變量（檢測是否在打包後的EXE中運行）

- **UI改進**
  - 索引改為固定選項（下拉選單）
  - 選項改變時自動刷新預覽
  - 現代化UI設計
  - 預覽更新性能優化

- **打包優化**
  - 更新打包配置，包含所有新模組
  - 優化EXE文件大小
  - 改進錯誤處理（EXE模式下不輸出調試信息）

### 🧪 測試

- **壓力測試**
  - 創建 `stress_test.py` - 15個測試場景
  - 測試極長文件名、特殊字符、路徑遍歷等

- **用戶錯誤模擬**
  - 創建 `user_error_simulation.py` - 20個錯誤場景
  - 模擬非程式人員的常見錯誤操作

- **測試結果**
  - 所有測試場景已通過驗證
  - 所有安全漏洞已修復
  - 所有功能正常工作

### 📝 文檔

- 新增詳細的用戶操作手冊（`用户操作手册.md`）
- 更新所有MD文件說明
- 添加安全審計報告（`security_audit_report.md`）
- 添加測試總結報告（`TEST_SUMMARY.md`）
- 完善使用說明
- 更新打包說明（`打包說明.md`）
- 更新優化說明（`優化說明.md`）

---

## 技術亮點

### 實時預覽系統

**問題**：用戶切換參數時，預覽區域的圖片和文件名會消失，需要重新點擊文件才能看到預覽。

**根本原因**：
1. 文件名在 `show_single_file_preview` 中預先生成
2. 異步加載完成後顯示預先生成的文件名
3. 如果用戶在加載期間改了參數，顯示的還是舊文件名

**解決方案**：
1. **不預先生成文件名**：`show_single_file_preview` 只傳遞 `file_path`, `index`, `old_name`, `ext`
2. **實時生成文件名**：在 `_display_preview` 中調用 `generate_new_filename()` 實時生成
3. **唯一ID追蹤**：每次加載生成唯一 `load_id`，防止過時預覽覆蓋新預覽
4. **雙重檢查**：檢查 `load_id` 和 `current_preview_file`，確保顯示的是最新請求的預覽

**效果**：
- ✅ 切換參數時預覽立即更新
- ✅ 圖片始終保持顯示
- ✅ 文件名實時反映最新參數
- ✅ 快速連續切換不會混亂

### 並發控制機制

```python
# 生成唯一的加載ID
load_id = f"{file_path}_{index}_{time.time()}"
self.current_load_id = load_id

# 顯示時檢查是否為當前請求
if self.current_load_id != load_id:
    return  # 過時的請求，忽略

if self.current_preview_file != file_path:
    return  # 文件已改變，忽略

# 實時生成文件名
new_name = self.generate_new_filename(file_path, index)
```

### 異常處理和降級顯示

- 圖片加載失敗：顯示文件類型標記
- 預覽顯示失敗：至少顯示文件名
- 完整的 try-except 保護
- EXE模式下隱藏調試信息

## v1.0.0

### 初始版本

- 基本檔案重新命名功能
- 支援兩種命名規則（Character規則、夢想命名規則）
- 拖放功能
- 圖片/影片預覽功能
- 批量選擇檔案
- 調整順序功能
- 錯誤處理（檔案衝突處理）

